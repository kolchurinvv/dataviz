var margin={top:20,right:40,bottom:30,left:20},width=960-margin.left-margin.right,height=500-margin.top-margin.bottom,barWidth=Math.floor(width/19)-1,x=d3.scale.linear().range([barWidth/2,width-barWidth/2]),y=d3.scale.linear().range([height,0]),yAxis=d3.svg.axis().scale(y).orient("right").tickSize(-width).tickFormat(function(t){return Math.round(t/1e6)+"M"}),svg=d3.select(".totalVotes").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),birthyears=svg.append("g").attr("class","birthyears"),title=svg.append("text").attr("class","title").attr("dy",".71em").text(2e3);d3.csv("assets/datasets/population.csv",function(t,e){function r(){o in e&&(title.text(o),birthyears.transition().duration(750).attr("transform","translate("+(x(i)-x(o))+",0)"),s.selectAll("rect").data(function(t){return e[o][t]||[0,0]}).transition().duration(750).attr("y",y).attr("height",function(t){return height-y(t)}))}e.forEach(function(t){t.people=+t.people,t.year=+t.year,t.age=+t.age});var a=d3.max(e,function(t){return t.age}),n=d3.min(e,function(t){return t.year}),i=d3.max(e,function(t){return t.year}),o=i;x.domain([i-a,i]),y.domain([0,d3.max(e,function(t){return t.people})]),e=d3.nest().key(function(t){return t.year}).key(function(t){return t.year-t.age}).rollup(function(t){return t.map(function(t){return t.people})}).map(e),svg.append("g").attr("class","y axis").attr("transform","translate("+width+",0)").call(yAxis).selectAll("g").filter(function(t){return!t}).classed("zero",!0);var s=birthyears.selectAll(".birthyear").data(d3.range(n-a,i+1,5)).enter().append("g").attr("class","birthyear").attr("transform",function(t){return"translate("+x(t)+",0)"});s.selectAll("rect").data(function(t){return e[o][t]||[0,0]}).enter().append("rect").attr("x",-barWidth/2).attr("width",barWidth).attr("y",y).attr("height",function(t){return height-y(t)}),s.append("text").attr("y",height-4).text(function(t){return t}),svg.selectAll(".age").data(d3.range(0,a+1,5)).enter().append("text").attr("class","age").attr("x",function(t){return x(o-t)}).attr("y",height+4).attr("dy",".71em").text(function(t){return t}),window.focus(),d3.select(window).on("keydown",function(){switch(d3.event.keyCode){case 37:o=Math.max(n,o-10);break;case 39:o=Math.min(i,o+10);break}r()})});